<!-- distributed/master/templates/dashboard.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Distributed ML Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Roboto, Arial, sans-serif; margin: 16px; background: #f7f9fc; color: #222; }
        h1 { margin-bottom: 6px; }
        .row { display:flex; gap:20px; margin-bottom: 18px; }
        .col { background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(20,20,40,0.04); }
        #workers { min-width: 220px; }
        .worker { padding:6px 8px; border-radius:4px; margin-bottom:6px; background:#eef6ff; }
        #batches { max-height: 260px; overflow:auto; min-width: 420px; }
        .batch { padding:8px; margin-bottom:8px; border-radius:6px; border-left:4px solid #ccc; background:#fff; }
        .pending { border-left-color: #ffb86b; }
        .ack { border-left-color: #6be3a8; }
        #charts { display:flex; flex-wrap:wrap; gap:12px; }
        canvas { background: #ffffff; border-radius:6px; box-shadow: 0 1px 6px rgba(30,30,40,0.03); padding:8px; }
        .chart-card { width: 380px; padding:8px; }
    </style>
</head>
<body>
    <h1>Distributed ML Dashboard</h1>
    <div class="row">
        <div class="col" id="workers">
            <h3>Workers</h3>
            <div id="workersList"></div>
        </div>

        <div class="col" id="batches">
            <h3>Batches</h3>
            <div id="batchesList"></div>
        </div>
    </div>

    <div class="col">
        <h3>Sensor Streams (ML Predictions plotted)</h3>
        <div id="charts">
            <div class="chart-card"><canvas id="temperatureChart" width="380" height="160"></canvas></div>
            <div class="chart-card"><canvas id="humidityChart" width="380" height="160"></canvas></div>
            <div class="chart-card"><canvas id="pressureChart" width="380" height="160"></canvas></div>
            <div class="chart-card"><canvas id="lightChart" width="380" height="160"></canvas></div>
            <div class="chart-card"><canvas id="vibrationChart" width="380" height="160"></canvas></div>
        </div>
    </div>

    <script>
        const socket = io();
        const maxPoints = 20;
        let labels = [];

        // datasets
        let tempData = [], humData = [], pressData = [], lightData = [], vibData = [];

        function createLineChart(ctx, label) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: [],
                        borderWidth: 2,
                        fill: false,
                        tension: 0.2
                    }]
                },
                options: {
                    animation: false,
                    responsive: true,
                    scales: {
                        x: { display: true },
                        y: { display: true }
                    }
                }
            });
        }

        const tempChart = createLineChart(document.getElementById('temperatureChart').getContext('2d'), 'Temperature (pred)');
        const humChart = createLineChart(document.getElementById('humidityChart').getContext('2d'), 'Humidity (pred)');
        const pressChart = createLineChart(document.getElementById('pressureChart').getContext('2d'), 'Pressure (pred)');
        const lightChart = createLineChart(document.getElementById('lightChart').getContext('2d'), 'Light (pred)');
        const vibChart = createLineChart(document.getElementById('vibrationChart').getContext('2d'), 'Vibration (pred)');

        function pushPoint(valueArr) {
            const ts = new Date().toLocaleTimeString();
            labels.push(ts);
            if (labels.length > maxPoints) labels.shift();

            tempData.push(valueArr[0]); if (tempData.length > maxPoints) tempData.shift();
            humData.push(valueArr[1]); if (humData.length > maxPoints) humData.shift();
            pressData.push(valueArr[2]); if (pressData.length > maxPoints) pressData.shift();
            lightData.push(valueArr[3]); if (lightData.length > maxPoints) lightData.shift();
            vibData.push(valueArr[4]); if (vibData.length > maxPoints) vibData.shift();

            tempChart.data.labels = labels; tempChart.data.datasets[0].data = tempData; tempChart.update();
            humChart.data.labels = labels; humChart.data.datasets[0].data = humData; humChart.update();
            pressChart.data.labels = labels; pressChart.data.datasets[0].data = pressData; pressChart.update();
            lightChart.data.labels = labels; lightChart.data.datasets[0].data = lightData; lightChart.update();
            vibChart.data.labels = labels; vibChart.data.datasets[0].data = vibData; vibChart.update();
        }

        socket.on('update', function(state) {
            // workers
            const workersList = document.getElementById('workersList');
            workersList.innerHTML = '';
            (state.workers || []).forEach(w => {
                const d = document.createElement('div');
                d.className = 'worker';
                d.textContent = w;
                workersList.appendChild(d);
            });

            // batches
            const batchesList = document.getElementById('batchesList');
            batchesList.innerHTML = '';
            const batches = state.batches || {};
            Object.keys(batches).reverse().forEach(bid => {
                const b = batches[bid];
                const el = document.createElement('div');
                el.className = 'batch ' + (b.status || 'pending');
                el.innerHTML = `<strong>${bid}</strong><div>worker: ${b.worker || 'N/A'}</div><div>status: ${b.status}</div><div>attempts: ${b.attempts || 0}</div><div>result: ${JSON.stringify(b.result)}</div>`;
                batchesList.appendChild(el);

                // if there is a predictions array, push to charts (use last predictions)
                if (b.result && b.result.predictions && Array.isArray(b.result.predictions)) {
                    // take predictions[0..4] (ensure length 5)
                    let preds = b.result.predictions.slice(0,5);
                    if (preds.length < 5) {
                        while (preds.length < 5) preds.push(0);
                    }
                    pushPoint(preds);
                }
            });
        });

        // keep connection alive (optional)
        socket.on('connect', () => { console.log('connected to dashboard socket'); });
    </script>
</body>
</html>
